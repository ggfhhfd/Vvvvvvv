<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø³ØªÙˆØ¯Ø¹ Ø£Ø±Ø´ÙŠÙ Ø³Ø¨ÙŠØ³ØªÙˆÙ†</title>
    <style>
        :root {
            --bg: #020617;
            --card: #0f172a;
            --primary: #6366f1;
            --success: #10b981;
            --text: #f8fafc;
            --accent: #f59e0b;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px 15px;
            display: flex;
            justify-content: center;
        }

        .container { width: 100%; max-width: 500px; background: var(--card); padding: 25px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05); }

        h2 { text-align: center; color: var(--primary); margin-bottom: 20px; font-size: 1.6rem; }

        input[type="text"] {
            width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #1e293b;
            background: #020617; color: white; margin-bottom: 10px; box-sizing: border-box; outline: none;
        }

        .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }

        button { padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 14px; }

        .btn-url { background: var(--primary); color: white; }
        .btn-file { background: #1e293b; color: white; border: 1px solid var(--primary); }

        #videoBox { display: none; width: 100%; border-radius: 18px; overflow: hidden; background: #000; margin-top: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        video { width: 100%; aspect-ratio: 16/9; display: block; }

        .loader { display: none; text-align: center; margin: 15px 0; }
        .bar { width: 100%; height: 6px; background: #1e293b; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .fill { width: 0%; height: 100%; background: var(--success); }

        .section-title { font-size: 14px; color: var(--accent); margin: 25px 0 10px; border-bottom: 1px solid #1e293b; padding-bottom: 5px; display: flex; align-items: center; gap: 5px; }

        .item {
            background: #1e293b; padding: 14px; border-radius: 14px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center; font-size: 13px; cursor: pointer; transition: 0.2s;
        }
        .item:active { transform: scale(0.98); background: #334155; }
        .item span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 75%; }
        
        .del-btn { background: #ef4444; color: white; padding: 6px 10px; border-radius: 8px; font-size: 10px; border: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù‚Ù†Ø§Ø© ğŸ“¼</h2>
    
    <input type="text" id="urlInput" placeholder="Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù‡Ù†Ø§...">
    
    <div class="btns">
        <button class="btn-url" onclick="handleUrl()">Ø­ÙØ¸ ÙˆØªØ´ØºÙŠÙ„</button>
        <button class="btn-file" onclick="document.getElementById('fInput').click()">ğŸ“ Ø§Ø±ÙØ¹ Ù…Ù„ÙÙƒ</button>
    </div>

    <input type="file" id="fInput" hidden accept="video/*" onchange="handleFileUpload(event)">

    <div id="loader" class="loader">
        <span id="status" style="font-size:12px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</span>
        <div class="bar"><div id="fill" class="fill"></div></div>
    </div>

    <div id="videoBox"></div>

    <div class="section-title">ğŸŒ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø´Ø¨ÙƒØ© (Ù„Ù„Ø¬Ù…ÙŠØ¹)</div>
    <div id="publicList"></div>

    <div class="section-title">ğŸ”’ Ù…ÙƒØªØ¨ØªÙƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Ø£ÙˆÙÙ„Ø§ÙŠÙ†)</div>
    <div id="list"></div>
</div>

<script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¹Ø§Ù… ---
    // Ù‡Ù†Ø§ ØªØ¶Ø¹ Ø§Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø°ÙŠ ØªØ±ÙØ¹Ù‡ Ø¹Ù„Ù‰ GitHub Ø£Ùˆ Ø±Ø§Ø¨Ø·Ù‡ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
    const publicPlaylist = [
        { name: "ÙÙŠØ¯ÙŠÙˆ Ø³Ø¨ÙŠØ³ØªÙˆÙ† 2001", url: "https://abra--5e4bd524.api.cosmic-crab.buzz/93743992fdffe15b7e075a2e81c5b05c5072c1bc/%D8%A7%D8%B1%D8%B4%D9%8A%D9%81%20%D9%82%D9%86%D8%A7%D8%A9%20%D8%B3%D8%A8%D9%8A%D8%B3%D8%AA%D9%88%D9%86%20%D9%85%D9%86%20%D8%B3%D9%86%D8%A9%202000%20%D8%A7%D9%84%D9%89%202001/2001-new-boy-asbys-ton-daaay-alaloan-alshry-mn.mp4?api-key=8acbcf1e-732c-4574-a3bf-27e6a85b86f1&download=true&token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NjgxNjIwNjcsInJhdGUiOiI1TSIsInJvbGUiOiJmcmVlIiwic2Vzc2lvbklEIjoiTVRjMk5qTXpORGMxTW54T2QzZEJUa1pzVUZORk5VUlJWbWhZVlZVMVVGTlZiRk5VVm1kNVYxWnNVMVpGUmtWU1JWRXdUVEE1V0ZacVVrbE5hazVLVTBVMVNGTlZNVWRXYTNoaFRXc3hSVlpFV2tkTk1FVTlmUFhVQTl0VjJsOURkcEh0RGEzVjJoTlM1N1lzV3Rfd0s2VW5sUGl6N2tOUyIsImRvbWFpbiI6IndlYnRvci5pbyIsImFnZW50IjoiTW96aWxsYS81LjAgKE1hY2ludG9zaDsgSW50ZWwgTWFjIE9TIFggMTBfMTVfNykgQXBwbGVXZWJLaXQvNjA1LjEuMTUgKEtIVE1MLCBsaWtlIEdlY2tvKSBWZXJzaW9uLzE2LjYuMSBTYWZhcmkvNjA1LjEuMTUiLCJyZW1vdGVBZGRyZXNzIjoiMjAwMToxNmE0OjJlNzphZjk1OjZkOTQ6ZDE2Nzo0OWE6NWJhNSJ9.sxGhoYLer04LWYEYlL8bTvkKITbWTUmrn9eA3Im5Kio" },
        { name: "ÙØ§ØµÙ„ Ù‚Ø¯ÙŠÙ… Ù†Ø§Ø¯Ø±Ø§Ù‹", url: "https://Ø±Ø§Ø¨Ø·-Ø¢Ø®Ø±-Ù…Ø¨Ø§Ø´Ø±.mp4" }
    ];

    const dbName = "MegaArchiveDB";
    let db;

    const req = indexedDB.open(dbName, 1);
    req.onupgradeneeded = (e) => { e.target.result.createObjectStore("files", { keyPath: "id" }); };
    req.onsuccess = (e) => { 
        db = e.target.result; 
        renderPublicPlaylist();
        renderLibrary(); 
    };

    function renderPublicPlaylist() {
        const pList = document.getElementById('publicList');
        pList.innerHTML = '';
        publicPlaylist.forEach(item => {
            const div = document.createElement('div');
            div.className = 'item';
            div.style.borderRight = "4px solid var(--accent)";
            div.innerHTML = `<span>ğŸ“º ${item.name}</span>`;
            div.onclick = () => {
                document.getElementById('urlInput').value = item.url;
                handleUrl();
            };
            pList.appendChild(div);
        });
    }

    async function handleUrl() {
        const url = document.getElementById('urlInput').value.trim();
        if (!url) return;

        const check = await getFromDB(url);
        if (check) { play(check.blob); return; }

        showLoader(true, "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† Ù„Ù„Ø£Ø¨Ø¯...");
        try {
            const res = await fetch(url);
            const total = +res.headers.get('content-length') || 0;
            const reader = res.body.getReader();
            let loaded = 0, chunks = [];

            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                loaded += value.length;
                if(total) updateProgress(Math.round((loaded/total)*100));
            }
            const blob = new Blob(chunks);
            await saveToDB(url, blob, "Ø±Ø§Ø¨Ø·");
            play(blob);
        } catch(e) { alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø­Ù…ÙŠ Ø£Ùˆ ØºÙŠØ± Ù…Ø¨Ø§Ø´Ø±."); }
        showLoader(false);
    }

    async function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        showLoader(true, "Ø¬Ø§Ø±ÙŠ Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù…ÙƒØªØ¨Ø©...");
        await saveToDB(file.name, file, "Ù…Ø­Ù„ÙŠ");
        updateProgress(100);
        setTimeout(() => { showLoader(false); play(file); renderLibrary(); }, 500);
    }

    function saveToDB(id, blob, type) {
        return new Promise(res => {
            const tx = db.transaction("files", "readwrite");
            tx.objectStore("files").put({ id, blob, type, date: new Date().toLocaleDateString() });
            tx.oncomplete = () => { renderLibrary(); res(); };
        });
    }

    function getFromDB(id) {
        return new Promise(res => {
            const tx = db.transaction("files", "readonly");
            tx.objectStore("files").get(id).onsuccess = (e) => res(e.target.result);
        });
    }

    function renderLibrary() {
        const list = document.getElementById('list');
        db.transaction("files", "readonly").objectStore("files").getAll().onsuccess = (e) => {
            const items = e.target.result;
            list.innerHTML = items.length ? '' : '<p style="color:#475569; font-size:12px; text-align:center;">Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© ÙØ§Ø±ØºØ©</p>';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<span>ğŸ“‚ ${item.id}</span> <button class="del-btn" onclick="deleteItem('${item.id}')">Ø­Ø°Ù</button>`;
                div.onclick = (ev) => { if(ev.target.tagName !== 'BUTTON') play(item.blob); };
                list.appendChild(div);
            });
        };
    }

    function deleteItem(id) {
        if(confirm("Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©ØŸ")) {
            const tx = db.transaction("files", "readwrite");
            tx.objectStore("files").delete(id);
            tx.oncomplete = () => renderLibrary();
        }
    }

    function play(blob) {
        const box = document.getElementById('videoBox');
        const vUrl = URL.createObjectURL(blob);
        box.innerHTML = `<video controls autoplay playsinline><source src="${vUrl}"></video>`;
        box.style.display = 'block';
        box.scrollIntoView({behavior: 'smooth'});
    }

    function showLoader(show, msg = "") {
        document.getElementById('loader').style.display = show ? 'block' : 'none';
        document.getElementById('status').innerText = msg;
    }

    function updateProgress(p) { document.getElementById('fill').style.width = p + '%'; }
</script>

</body>
</html>
