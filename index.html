<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø´Ø§Ù…Ù„</title>
    <style>
        :root {
            --bg: #020617;
            --card: #0f172a;
            --primary: #6366f1;
            --success: #10b981;
            --text: #f8fafc;
        }

        body {
            font-family: system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px 15px;
            display: flex;
            justify-content: center;
        }

        .container { width: 100%; max-width: 500px; background: var(--card); padding: 25px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

        h2 { text-align: center; color: var(--primary); margin-bottom: 20px; }

        input[type="text"] {
            width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #1e293b;
            background: #020617; color: white; margin-bottom: 10px; box-sizing: border-box;
        }

        .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }

        button {
            padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s;
        }

        .btn-url { background: var(--primary); color: white; }
        .btn-file { background: #1e293b; color: white; border: 1px solid var(--primary); }

        #videoBox { display: none; width: 100%; border-radius: 15px; overflow: hidden; background: #000; margin-top: 20px; }
        video { width: 100%; aspect-ratio: 16/9; }

        .loader { display: none; text-align: center; margin: 15px 0; }
        .bar { width: 100%; height: 6px; background: #1e293b; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .fill { width: 0%; height: 100%; background: var(--success); }

        .library { margin-top: 30px; border-top: 1px solid #1e293b; padding-top: 15px; }
        .item {
            background: #1e293b; padding: 12px; border-radius: 12px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center; font-size: 12px;
        }
        .item span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 70%; }
        .del-btn { background: #ef4444; color: white; padding: 5px 10px; border-radius: 8px; font-size: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙƒÙŠ ğŸ“¥</h2>
    
    <input type="text" id="urlInput" placeholder="Ø¥Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ...">
    
    <div class="btns">
        <button class="btn-url" onclick="handleUrl()">Ø­ÙØ¸ ÙˆØªØ´ØºÙŠÙ„ Ø±Ø§Ø¨Ø·</button>
        <button class="btn-file" onclick="document.getElementById('fInput').click()">ğŸ“ Ø§Ø±ÙØ¹ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</button>
    </div>

    <input type="file" id="fInput" hidden accept="video/*" onchange="handleFileUpload(event)">

    <div id="loader" class="loader">
        <span id="status" style="font-size:12px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</span>
        <div class="bar"><div id="fill" class="fill"></div></div>
    </div>

    <div id="videoBox"></div>

    <div class="library">
        <h3 style="font-size:14px;">Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª):</h3>
        <div id="list"></div>
    </div>
</div>

<script>
    const dbName = "MegaVideoDB";
    let db;

    // ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const req = indexedDB.open(dbName, 1);
    req.onupgradeneeded = (e) => { e.target.result.createObjectStore("files", { keyPath: "id" }); };
    req.onsuccess = (e) => { db = e.target.result; renderLibrary(); };

    // 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (Ù†ÙØ³ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§Ø¦Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚)
    async function handleUrl() {
        const url = document.getElementById('urlInput').value.trim();
        if (!url) return;

        const check = await getFromDB(url);
        if (check) { play(check.blob); return; }

        showLoader(true);
        try {
            const res = await fetch(url);
            const total = +res.headers.get('content-length');
            const reader = res.body.getReader();
            let loaded = 0, chunks = [];

            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                loaded += value.length;
                updateProgress(Math.round((loaded/total)*100));
            }
            const blob = new Blob(chunks);
            await saveToDB(url, blob, "Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ");
            play(blob);
        } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ù„Ø­Ù…Ø§ÙŠØ©"); }
        showLoader(false);
    }

    // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² (Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ø­ÙØ¸ Ø§Ù„Ø¯Ø§Ø¦Ù…)
    async function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        showLoader(true, "Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªØµÙØ­...");
        updateProgress(50); // Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù

        await saveToDB(file.name, file, "Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²");
        
        updateProgress(100);
        setTimeout(() => {
            showLoader(false);
            play(file);
            renderLibrary();
        }, 500);
    }

    // ÙˆØ¸Ø§Ø¦Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function saveToDB(id, blob, type) {
        return new Promise(res => {
            const tx = db.transaction("files", "readwrite");
            tx.objectStore("files").put({ id, blob, type, date: new Date().toLocaleDateString() });
            tx.oncomplete = () => res();
        });
    }

    function getFromDB(id) {
        return new Promise(res => {
            const tx = db.transaction("files", "readonly");
            tx.objectStore("files").get(id).onsuccess = (e) => res(e.target.result);
        });
    }

    function renderLibrary() {
        const list = document.getElementById('list');
        db.transaction("files", "readonly").objectStore("files").getAll().onsuccess = (e) => {
            const items = e.target.result;
            list.innerHTML = items.length ? '' : '<p style="color:#475569; font-size:12px;">Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ©</p>';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<span>[${item.type}] ${item.id}</span> <button class="del-btn" onclick="deleteItem('${item.id}')">Ø­Ø°Ù</button>`;
                div.onclick = (ev) => { if(ev.target.tagName !== 'BUTTON') play(item.blob); };
                list.appendChild(div);
            });
        };
    }

    function deleteItem(id) {
        const tx = db.transaction("files", "readwrite");
        tx.objectStore("files").delete(id);
        tx.oncomplete = () => renderLibrary();
    }

    // Ø§Ù„Ù…Ø´ØºÙ„ ÙˆØ§Ù„Ù„ÙˆØ¯Ø±
    function play(blob) {
        const box = document.getElementById('videoBox');
        box.innerHTML = `<video controls autoplay playsinline><source src="${URL.createObjectURL(blob)}"></video>`;
        box.style.display = 'block';
        box.scrollIntoView({behavior: 'smooth'});
    }

    function showLoader(show, msg = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...") {
        document.getElementById('loader').style.display = show ? 'block' : 'none';
        document.getElementById('status').innerText = msg;
    }

    function updateProgress(p) { document.getElementById('fill').style.width = p + '%'; }
</script>

</body>
</html>
