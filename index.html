<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ClashData Pro | Bypass Size Limit</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --card: #1e1e1e; --text: #ffffff; --success: #2ed573; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .upload-container { background: var(--card); padding: 25px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.7); width: 100%; max-width: 500px; box-sizing: border-box; border: 1px solid #333; }
        h2 { color: var(--primary); text-align: center; margin-bottom: 20px; }
        .tabs { display: flex; background: #121212; border-radius: 15px; padding: 5px; margin-bottom: 20px; }
        .tab-btn { background: transparent; border: none; color: #888; padding: 12px; cursor: pointer; border-radius: 12px; transition: 0.3s; flex: 1; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
        input { background: #2d2d2d; border: 2px solid #333; padding: 15px; border-radius: 12px; width: 100%; box-sizing: border-box; color: white; margin-bottom: 15px; }
        .progress-wrapper { display: none; width: 100%; background: #121212; height: 12px; border-radius: 10px; margin-bottom: 15px; overflow: hidden; border: 1px solid #333; }
        #progressBar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), #ff6b81); transition: width 0.3s ease; }
        button#actionBtn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; }
        button:disabled { background: #444; cursor: not-allowed; }
        #status { font-size: 13px; margin-bottom: 8px; text-align: center; color: #eccc68; }
        .video-grid { width: 100%; max-width: 500px; margin-top: 20px; }
        .video-item { background: var(--card); border-radius: 20px; margin-bottom: 25px; overflow: hidden; border: 1px solid #2a2a2a; }
        video { width: 100%; display: block; background: #000; height: 250px; }
        .video-info { padding: 15px; }
        .btns-group { display: flex; gap: 10px; margin-top: 10px; }
        .download-btn { flex: 2; background: var(--success); color: white; text-decoration: none; padding: 10px; border-radius: 10px; text-align: center; font-weight: bold; font-size: 14px; }
        .delete-btn { flex: 1; background: rgba(255, 71, 87, 0.1); color: var(--primary); border: 1px solid var(--primary); padding: 10px; border-radius: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="upload-container">
        <h2>ğŸš€ ClashData Pro</h2>
        <div class="tabs">
            <button class="tab-btn active" id="btn-file" onclick="setMode('file')">Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ</button>
            <button class="tab-btn" id="btn-url" onclick="setMode('url')">Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±</button>
        </div>

        <div id="inputArea">
            <input type="file" id="videoFile" accept="video/*">
        </div>
        
        <div id="status"></div>
        <div class="progress-wrapper" id="progWrapper"><div id="progressBar"></div></div>

        <button id="actionBtn" onclick="startUpload()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±ÙØ¹ (ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ù€ 100MB)</button>
    </div>

    <div id="videoList" class="video-grid"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAm1OfTW_qS4lhSGlqgDd6fiLDj3u93wqI",
        authDomain: "clashdata-8424c.firebaseapp.com",
        databaseURL: "https://clashdata-8424c-default-rtdb.firebaseio.com",
        projectId: "clashdata-8424c",
        storageBucket: "clashdata-8424c.firebasestorage.app",
        appId: "1:1063000922754:web:87087f81c28c2659cb329b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const CLOUD_NAME = "dkpddgzqj";
    const UPLOAD_PRESET = "b2aumssr";

    let mode = 'file';

    window.setMode = function(m) {
        mode = m;
        document.getElementById('btn-file').classList.toggle('active', m === 'file');
        document.getElementById('btn-url').classList.toggle('active', m === 'url');
        document.getElementById('inputArea').innerHTML = m === 'file' 
            ? '<input type="file" id="videoFile" accept="video/*">' 
            : '<input type="text" id="videoUrlInput" placeholder="Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±...">';
    };

    window.startUpload = async function() {
        const fileInput = document.getElementById('videoFile');
        const urlInput = document.getElementById('videoUrlInput');
        const source = mode === 'file' ? fileInput.files[0] : urlInput.value;

        if(!source) return alert("ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ø£Ùˆ Ø¶Ø¹ Ø±Ø§Ø¨Ø·Ø§Ù‹");

        const btn = document.getElementById('actionBtn');
        const status = document.getElementById('status');
        const progWrapper = document.getElementById('progWrapper');
        const progressBar = document.getElementById('progressBar');

        btn.disabled = true;
        progWrapper.style.display = "block";
        status.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø°ÙƒÙŠ...";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±ÙØ¹ Ø¨Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡
        const CHUNK_SIZE = 5 * 1024 * 1024; // 5 Ù…ÙŠØ¬Ø§ Ù„ÙƒÙ„ Ù‚Ø·Ø¹Ø©
        const file = source;
        const totalSize = file.size;
        const uniqueId = 'clash_' + Date.now();

        try {
            if (mode === 'url') {
                // Ù„Ù„Ø±ÙˆØ§Ø¨Ø·ØŒ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙƒØ¨ÙŠØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ Ù‚Ø¯ ÙŠÙØ´Ù„ØŒ ÙŠÙØ¶Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ù†ÙØ³Ù‡)
                await uploadNormal(source);
            } else {
                // Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©ØŒ Ø§Ù„ØªÙ‚Ø³ÙŠÙ… Ù„Ù‚Ø·Ø¹
                for (let start = 0; start < totalSize; start += CHUNK_SIZE) {
                    const end = Math.min(start + CHUNK_SIZE, totalSize);
                    const chunk = file.slice(start, end);
                    const isLast = end === totalSize;
                    const contentRange = `bytes ${start}-${end - 1}/${totalSize}`;
                    
                    await uploadChunk(chunk, contentRange, uniqueId, isLast);
                    
                    const percent = Math.round((end / totalSize) * 100);
                    progressBar.style.width = percent + "%";
                    status.innerText = `ØªÙ… Ø±ÙØ¹: ${percent}%`;
                }
            }
        } catch (error) {
            alert("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: " + error.message);
            btn.disabled = false;
        }
    };

    async function uploadChunk(chunk, range, uniqueId, isLast) {
        const formData = new FormData();
        formData.append('file', chunk);
        formData.append('upload_preset', UPLOAD_PRESET);
        formData.append('resource_type', 'video');

        const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Unique-Upload-Id': uniqueId,
                'Content-Range': range
            }
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error.message);
        if (isLast) saveToFirebase(data);
    }

    async function uploadNormal(url) {
        const formData = new FormData();
        formData.append('file', url);
        formData.append('upload_preset', UPLOAD_PRESET);
        formData.append('resource_type', 'video');

        const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error.message);
        saveToFirebase(data);
    }

    function saveToFirebase(data) {
        push(ref(db, 'my_videos'), {
            name: mode === 'file' ? document.getElementById('videoFile').files[0].name : "ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø±Ø§Ø¨Ø·",
            url: data.secure_url,
            format: data.format,
            date: new Date().toLocaleString('ar-SA')
        });
        document.getElementById('status').innerText = "âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!";
        setTimeout(() => location.reload(), 2000);
    }

    onValue(ref(db, 'my_videos'), (snapshot) => {
        const listDiv = document.getElementById('videoList');
        listDiv.innerHTML = "";
        const data = snapshot.val();
        if(data) {
            Object.keys(data).reverse().forEach(key => {
                const v = data[key];
                // ØªØ­ÙˆÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ØµÙŠØºØ© Ù„ØªØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
                const displayUrl = v.url.replace(new RegExp(`\\.${v.format}$`), '.mp4').replace('/upload/', '/upload/f_auto,q_auto/');
                const item = document.createElement('div');
                item.className = 'video-item';
                item.innerHTML = `
                    <video controls preload="metadata" src="${displayUrl}"></video>
                    <div class="video-info">
                        <div style="font-weight:bold; margin-bottom:10px;">${v.name}</div>
                        <div class="btns-group">
                            <a href="${v.url.replace('/upload/', '/upload/fl_attachment/')}" class="download-btn">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù ğŸ“¥</a>
                            <button class="delete-btn" onclick="deleteV('${key}')">Ø­Ø°Ù ğŸ—‘ï¸</button>
                        </div>
                    </div>`;
                listDiv.appendChild(item);
            });
        }
    });

    window.deleteV = function(id) {
        if(prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø°Ù:") === "1234") remove(ref(db, `my_videos/${id}`));
    };
</script>
</body>
</html>
