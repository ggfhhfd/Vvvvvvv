<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙØ­Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ø§ØµØ©</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #007bff; }
        #videoPlayer { width: 100%; border-radius: 10px; display: none; margin-top: 20px; }
        .btn { background-color: #28a745; color: white; border: none; padding: 15px 25px; font-size: 18px; border-radius: 8px; cursor: pointer; transition: 0.3s; margin-top: 20px; width: 100%; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-delete { background-color: #dc3545; font-size: 14px; padding: 8px; margin-top: 10px; }
        #status { margin-top: 15px; font-size: 14px; color: #666; }
        .progress-bar { width: 100%; background: #eee; height: 10px; border-radius: 5px; margin-top: 10px; display: none; }
        #progressFill { width: 0%; height: 100%; background: #28a745; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ ØµØ¯ÙŠÙ‚ÙŠ ğŸ‘‹</h2>
    <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆÙ…Ø´Ø§Ù‡Ø¯ØªÙ‡ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª.</p>
    
    <button id="downloadBtn" class="btn">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø£ÙˆÙÙ„Ø§ÙŠÙ†</button>
    
    <div class="progress-bar" id="progressBar"><div id="progressFill"></div></div>
    <p id="status">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„...</p>

    <video id="videoPlayer" controls></video>
    
    <button id="deleteBtn" class="btn btn-delete" style="display:none;">Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©</button>
</div>

<script>
    const VIDEO_URL = 'v.mp4'; // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø­Ù‚Ùƒ Ø§Ù„Ù…Ø±ÙÙˆØ¹ Ø¹Ù„Ù‰ GitHub
    const downloadBtn = document.getElementById('downloadBtn');
    const videoPlayer = document.getElementById('videoPlayer');
    const status = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const deleteBtn = document.getElementById('deleteBtn');

    // ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØµÙØ­
    let db;
    const request = indexedDB.open("OfflineVideoDB", 1);
    request.onupgradeneeded = e => e.target.result.createObjectStore("videos");
    request.onsuccess = e => {
        db = e.target.result;
        checkIfStored();
    };

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹
    function checkIfStored() {
        const transaction = db.transaction("videos", "readonly");
        const getRequest = transaction.objectStore("videos").get("savedVideo");
        getRequest.onsuccess = () => {
            if (getRequest.result) {
                showVideo(getRequest.result);
                status.innerText = "Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø­Ù…Ù„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª!";
                downloadBtn.style.display = 'none';
                deleteBtn.style.display = 'inline-block';
            }
        };
    }

    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    downloadBtn.onclick = async () => {
        downloadBtn.disabled = true;
        status.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©";
        progressBar.style.display = 'block';

        try {
            const response = await fetch(VIDEO_URL);
            if (!response.ok) throw new Error("ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„");
            
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ù…ÙŠÙ„
            const reader = response.body.getReader();
            const contentLength = +response.headers.get('Content-Length');
            let receivedLength = 0;
            let chunks = [];

            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                receivedLength += value.length;
                let percent = Math.round((receivedLength / contentLength) * 100);
                progressFill.style.width = percent + '%';
            }

            const blob = new Blob(chunks);
            const transaction = db.transaction("videos", "readwrite");
            transaction.objectStore("videos").put(blob, "savedVideo");
            
            transaction.oncomplete = () => {
                showVideo(blob);
                status.innerText = "ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø·ÙØ§Ø¡ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆÙ…Ø´Ø§Ù‡Ø¯ØªÙ‡.";
                downloadBtn.style.display = 'none';
                deleteBtn.style.display = 'inline-block';
            };
        } catch (err) {
            status.innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„: " + err.message;
            downloadBtn.disabled = false;
        }
    };

    function showVideo(blob) {
        videoPlayer.src = URL.createObjectURL(blob);
        videoPlayer.style.display = 'block';
        progressBar.style.display = 'none';
    }

    // Ø²Ø± Ø§Ù„Ø­Ø°Ù Ù„ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø©
    deleteBtn.onclick = () => {
        const transaction = db.transaction("videos", "readwrite");
        transaction.objectStore("videos").delete("savedVideo");
        transaction.oncomplete = () => {
            location.reload();
        };
    };
</script>

</body>
</html>
