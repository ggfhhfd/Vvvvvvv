<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Pro</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --accent: #f59e0b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px 10px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container { 
            width: 100%; 
            max-width: 600px; 
            background: var(--card); 
            padding: 25px; 
            border-radius: 24px; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }

        h2 { text-align: center; color: var(--primary); margin-bottom: 25px; font-size: 1.8rem; letter-spacing: -1px; }

        .input-group { position: relative; margin-bottom: 15px; }
        input[type="text"], .search-bar {
            width: 100%; padding: 15px 20px; border-radius: 14px; border: 2px solid #334155;
            background: #020617; color: white; box-sizing: border-box; outline: none;
            transition: border-color 0.3s;
        }
        input:focus { border-color: var(--primary); }

        .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }

        button { 
            padding: 14px; border-radius: 12px; border: none; font-weight: 600; 
            cursor: pointer; transition: all 0.2s; font-size: 14px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        .btn-url { background: var(--primary); color: white; }
        .btn-url:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-file { background: transparent; color: white; border: 2px solid var(--primary); }
        .btn-file:hover { background: rgba(99, 102, 241, 0.1); }

        #videoBox { 
            display: none; width: 100%; border-radius: 20px; overflow: hidden; 
            background: #000; margin-top: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
        }
        video { width: 100%; display: block; }

        .loader { display: none; margin: 20px 0; background: rgba(2, 6, 23, 0.5); padding: 15px; border-radius: 15px; }
        .bar { width: 100%; height: 8px; background: #334155; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .fill { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); transition: width 0.3s; }

        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin: 30px 0 15px; border-bottom: 1px solid #334155; padding-bottom: 8px;
        }
        .section-title { font-size: 14px; color: var(--accent); font-weight: bold; }
        
        .search-bar { padding: 8px 15px; font-size: 12px; margin-bottom: 15px; border-radius: 8px; }

        .list-container { max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .list-container::-webkit-scrollbar { width: 5px; }
        .list-container::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        .item {
            background: #334155; padding: 14px; border-radius: 16px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center; 
            transition: 0.3s; border: 1px solid transparent;
        }
        .item:hover { background: #475569; border-color: var(--primary); }
        
        .item-info { display: flex; flex-direction: column; gap: 4px; max-width: 70%; cursor: pointer; }
        .item-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-meta { font-size: 10px; color: var(--text-dim); }

        .actions { display: flex; gap: 8px; }
        .del-btn { background: rgba(239, 68, 68, 0.1); color: var(--danger); padding: 8px; border-radius: 10px; border: 1px solid var(--danger); font-size: 11px; }
        .del-btn:hover { background: var(--danger); color: white; }

        .empty-msg { text-align: center; color: var(--text-dim); font-size: 13px; padding: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Ø£Ø±Ø´ÙŠÙÙƒ Ø§Ù„Ø°ÙƒÙŠ ğŸ“¼</h2>
    
    <div class="input-group">
        <input type="text" id="urlInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø± (MP4)...">
    </div>
    
    <div class="btns">
        <button class="btn-url" onclick="handleUrl()">ğŸš€ Ø­ÙØ¸ ÙˆØªØ´ØºÙŠÙ„</button>
        <button class="btn-file" onclick="document.getElementById('fInput').click()">ğŸ“ Ø±ÙØ¹ Ù…Ù„Ù</button>
    </div>

    <input type="file" id="fInput" hidden accept="video/*" onchange="handleFileUpload(event)">

    <div id="loader" class="loader">
        <div style="display:flex; justify-content:space-between; font-size:12px;">
            <span id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</span>
            <span id="percent">0%</span>
        </div>
        <div class="bar"><div id="fill" class="fill"></div></div>
    </div>

    <div id="videoBox"></div>

    <div class="section-header">
        <span class="section-title">ğŸ“‚ Ù…ÙƒØªØ¨ØªÙƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</span>
        <span id="count" style="font-size: 12px; color: var(--text-dim);">0 ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</span>
    </div>

    <input type="text" class="search-bar" id="searchInput" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª..." oninput="renderLibrary()">

    <div id="list" class="list-container"></div>
</div>

<script>
    const dbName = "SmartArchiveDB";
    let db;
    let currentVideoUrl = null;

    // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const req = indexedDB.open(dbName, 2);
    req.onupgradeneeded = (e) => {
        const store = e.target.result.createObjectStore("files", { keyPath: "id" });
        store.createIndex("date", "date");
    };
    req.onsuccess = (e) => { 
        db = e.target.result; 
        renderLibrary(); 
    };

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
    async function handleUrl() {
        const url = document.getElementById('urlInput').value.trim();
        if (!url) return;

        const existing = await getFromDB(url);
        if (existing) { play(existing.blob); return; }

        showLoader(true, "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error();
            
            const reader = res.body.getReader();
            const total = +res.headers.get('content-length') || 0;
            let loaded = 0, chunks = [];

            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                loaded += value.length;
                if(total) updateProgress(Math.round((loaded/total)*100));
            }

            const blob = new Blob(chunks);
            const fileName = url.split('/').pop().split('?')[0] || "ÙÙŠØ¯ÙŠÙˆ Ø®Ø§Ø±Ø¬ÙŠ";
            await saveToDB(url, blob, fileName, "Ø±Ø§Ø¨Ø·", total);
            play(blob);
        } catch(e) {
            alert("ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± ÙˆÙŠØ¯Ø¹Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø¹Ø§Ù… (CORS).");
        }
        showLoader(false);
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
    async function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        showLoader(true, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹...");
        updateProgress(50);
        await saveToDB(file.name + Date.now(), file, file.name, "Ù…Ø­Ù„ÙŠ", file.size);
        updateProgress(100);
        
        setTimeout(() => { 
            showLoader(false); 
            play(file); 
            renderLibrary(); 
        }, 400);
    }

    // Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ IndexedDB
    function saveToDB(id, blob, name, type, size) {
        return new Promise(res => {
            const tx = db.transaction("files", "readwrite");
            tx.objectStore("files").put({ 
                id, blob, name, type, 
                size: (size / (1024*1024)).toFixed(2) + " MB",
                date: new Date().toLocaleDateString('ar-SA')
            });
            tx.oncomplete = () => { renderLibrary(); res(); };
        });
    }

    function getFromDB(id) {
        return new Promise(res => {
            const tx = db.transaction("files", "readonly");
            tx.objectStore("files").get(id).onsuccess = (e) => res(e.target.result);
        });
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    function renderLibrary() {
        const list = document.getElementById('list');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        db.transaction("files", "readonly").objectStore("files").getAll().onsuccess = (e) => {
            const items = e.target.result.filter(i => i.name.toLowerCase().includes(searchTerm));
            document.getElementById('count').innerText = `${items.length} ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª`;
            
            list.innerHTML = items.length ? '' : '<div class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</div>';
            
            items.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(item => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
                    <div class="item-info">
                        <span class="item-name">ğŸ¬ ${item.name}</span>
                        <span class="item-meta">${item.date} â€¢ ${item.size}</span>
                    </div>
                    <div class="actions">
                        <button class="del-btn" onclick="deleteItem('${item.id}')">Ø­Ø°Ù</button>
                    </div>
                `;
                div.querySelector('.item-info').onclick = () => play(item.blob);
                list.appendChild(div);
            });
        };
    }

    function deleteItem(id) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
            const tx = db.transaction("files", "readwrite");
            tx.objectStore("files").delete(id);
            tx.oncomplete = () => {
                renderLibrary();
                if (document.getElementById('videoBox').style.display === 'block') {
                    document.getElementById('videoBox').style.display = 'none';
                }
            };
        }
    }

    function play(blob) {
        if (currentVideoUrl) URL.revokeObjectURL(currentVideoUrl);
        currentVideoUrl = URL.createObjectURL(blob);
        
        const box = document.getElementById('videoBox');
        box.innerHTML = `<video controls autoplay playsinline><source src="${currentVideoUrl}"></video>`;
        box.style.display = 'block';
        box.scrollIntoView({behavior: 'smooth'});
    }

    function showLoader(show, msg = "") {
        document.getElementById('loader').style.display = show ? 'block' : 'none';
        document.getElementById('status').innerText = msg;
        if(!show) updateProgress(0);
    }

    function updateProgress(p) { 
        document.getElementById('fill').style.width = p + '%'; 
        document.getElementById('percent').innerText = p + '%';
    }
</script>
</body>
</html>
