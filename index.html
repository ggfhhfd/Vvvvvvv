<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClashData - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #121212; color: white; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .upload-container { background: #1e1e1e; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; max-width: 450px; text-align: center; }
        h2 { color: #ff4757; margin-bottom: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .tab-btn { background: #333; border: none; color: white; padding: 10px 20px; cursor: pointer; border-radius: 10px; transition: 0.3s; flex: 1; }
        .tab-btn.active { background: #ff4757; font-weight: bold; }
        input { background: #2d2d2d; border: 1px solid #444; padding: 15px; border-radius: 10px; width: 100%; box-sizing: border-box; color: white; margin-bottom: 15px; }
        button#actionBtn { background: linear-gradient(45deg, #ff4757, #ff6b81); color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; font-size: 16px; }
        button:disabled { opacity: 0.5; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
        #progressWrap { width: 100%; background: #2d2d2d; border-radius: 10px; height: 10px; margin-bottom: 15px; display: none; overflow: hidden; }
        #progressBar { width: 0%; height: 100%; background: #2ed573; transition: width 0.1s; }

        .video-item { background: #262626; padding: 15px; border-radius: 15px; margin-top: 20px; width: 100%; max-width: 450px; border: 1px solid #333; }
        video { width: 100%; border-radius: 10px; margin-top: 10px; background: #000; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .video-title { font-size: 14px; font-weight: bold; color: #eee; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px; }
        .btns-group { display: flex; gap: 8px; }
        .download-btn { background: #2ed573; color: white; text-decoration: none; padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; }
        .delete-btn { background: none; color: #ff4757; border: 1px solid #ff4757; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .delete-btn:hover { background: #ff4757; color: white; }
    </style>
</head>
<body>

    <div class="upload-container">
        <h2>ğŸš€ ClashData</h2>
        
        <div class="tabs">
            <button class="tab-btn active" id="fileTab" onclick="toggleMode('file')">Ø±ÙØ¹ Ù…Ù„Ù</button>
            <button class="tab-btn" id="urlTab" onclick="toggleMode('url')">Ù„ØµÙ‚ Ø±Ø§Ø¨Ø·</button>
        </div>

        <div id="fileArea">
            <input type="file" id="videoFile" accept="video/*">
        </div>

        <div id="urlArea" style="display: none;">
            <input type="text" id="videoUrlInput" placeholder="Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· mp4 Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù‡Ù†Ø§...">
        </div>
        
        <div id="progressWrap"><div id="progressBar"></div></div>
        
        <p id="status" style="font-size: 13px; color: #eccc68; margin-bottom: 10px;"></p>
        <button id="actionBtn" onclick="processUpload()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±ÙØ¹ / Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
    </div>

    <h3 style="margin-top: 30px;">ğŸ“º Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h3>
    <div id="videoList" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAm1OfTW_qS4lhSGlqgDd6fiLDj3u93wqI",
        authDomain: "clashdata-8424c.firebaseapp.com",
        databaseURL: "https://clashdata-8424c-default-rtdb.firebaseio.com",
        projectId: "clashdata-8424c",
        storageBucket: "clashdata-8424c.firebasestorage.app",
        appId: "1:1063000922754:web:87087f81c28c2659cb329b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const CLOUD_NAME = "dkpddgzqj";
    const UPLOAD_PRESET = "b2aumssr";

    let uploadMode = 'file';

    window.toggleMode = function(m) {
        uploadMode = m;
        document.getElementById('fileArea').style.display = m === 'file' ? 'block' : 'none';
        document.getElementById('urlArea').style.display = m === 'url' ? 'block' : 'none';
        document.getElementById('fileTab').classList.toggle('active', m === 'file');
        document.getElementById('urlTab').classList.toggle('active', m === 'url');
    };

    window.processUpload = function() {
        const btn = document.getElementById('actionBtn');
        const status = document.getElementById('status');
        const progressWrap = document.getElementById('progressWrap');
        const progressBar = document.getElementById('progressBar');
        let source;

        if (uploadMode === 'file') {
            source = document.getElementById('videoFile').files[0];
            if (!source) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ");
        } else {
            source = document.getElementById('videoUrlInput').value;
            if (!source) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ");
        }

        btn.disabled = true;
        progressWrap.style.display = 'block';
        status.innerText = "Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø±ÙØ¹...";

        const formData = new FormData();
        formData.append('file', source);
        formData.append('upload_preset', UPLOAD_PRESET);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`, true);

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
        xhr.upload.onprogress = function(e) {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percent + '%';
                status.innerText = `Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹: ${percent}%`;
            }
        };

        xhr.onload = function() {
            const data = JSON.parse(xhr.responseText);
            if (xhr.status === 200 && data.secure_url) {
                const videoRef = ref(db, 'my_videos');
                push(videoRef, {
                    name: uploadMode === 'file' ? source.name : "ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ",
                    url: data.secure_url,
                    date: new Date().toISOString()
                }).then(() => {
                    status.innerText = "ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! âœ…";
                    btn.disabled = false;
                    progressWrap.style.display = 'none';
                    document.getElementById('videoUrlInput').value = "";
                    document.getElementById('videoFile').value = "";
                });
            } else {
                alert("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹. ØªØ£ÙƒØ¯ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ù„Ù…Ù„Ù.");
                btn.disabled = false;
                progressWrap.style.display = 'none';
            }
        };

        xhr.onerror = function() {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
            btn.disabled = false;
            progressWrap.style.display = 'none';
        };

        xhr.send(formData);
    };

    const videoListDiv = document.getElementById('videoList');
    onValue(ref(db, 'my_videos'), (snapshot) => {
        videoListDiv.innerHTML = "";
        const data = snapshot.val();
        if (data) {
            Object.keys(data).reverse().forEach(key => {
                const video = data[key];
                const downloadUrl = video.url.replace('/upload/', '/upload/fl_attachment/');
                const item = document.createElement('div');
                item.className = 'video-item';
                item.innerHTML = `
                    <div class="item-header">
                        <span class="video-title">${video.name}</span>
                        <div class="btns-group">
                            <a href="${downloadUrl}" class="download-btn">ØªØ­Ù…ÙŠÙ„ ğŸ“¥</a>
                            <button class="delete-btn" onclick="deleteVideo('${key}')">Ø­Ø°Ù ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <video controls src="${video.url}" preload="metadata"></video>
                `;
                videoListDiv.appendChild(item);
            });
        } else {
            videoListDiv.innerHTML = "<p style='color:#666;'>Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
        }
    });

    window.deleteVideo = function(id) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø©ØŸ")) {
            remove(ref(db, `my_videos/${id}`));
        }
    };
</script>
</body>
</html>
