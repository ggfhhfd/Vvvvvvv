<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ClashData Pro | Ultimate Upload</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --card: #1e1e1e; --text: #ffffff; --success: #2ed573; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .upload-container { background: var(--card); padding: 25px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.7); width: 100%; max-width: 500px; box-sizing: border-box; border: 1px solid #333; }
        h2 { color: var(--primary); text-align: center; margin-bottom: 20px; }
        .tabs { display: flex; background: #121212; border-radius: 15px; padding: 5px; margin-bottom: 20px; }
        .tab-btn { background: transparent; border: none; color: #888; padding: 12px; cursor: pointer; border-radius: 12px; transition: 0.3s; flex: 1; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
        input { background: #2d2d2d; border: 2px solid #333; padding: 15px; border-radius: 12px; width: 100%; box-sizing: border-box; color: white; margin-bottom: 15px; }
        .progress-wrapper { display: none; width: 100%; background: #121212; height: 12px; border-radius: 10px; margin-bottom: 15px; overflow: hidden; border: 1px solid #333; }
        #progressBar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), #ff6b81); transition: width 0.3s ease; }
        button#actionBtn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; }
        button:disabled { background: #444; cursor: not-allowed; }
        .video-grid { width: 100%; max-width: 500px; margin-top: 20px; }
        .video-item { background: var(--card); border-radius: 20px; margin-bottom: 25px; overflow: hidden; border: 1px solid #2a2a2a; }
        video { width: 100%; display: block; background: #000; height: 250px; }
        .video-info { padding: 15px; }
        .btns-group { display: flex; gap: 10px; margin-top: 10px; }
        .download-btn { flex: 2; background: var(--success); color: white; text-decoration: none; padding: 10px; border-radius: 10px; text-align: center; font-weight: bold; font-size: 14px; }
        .delete-btn { flex: 1; background: rgba(255, 71, 87, 0.1); color: var(--primary); border: 1px solid var(--primary); padding: 10px; border-radius: 10px; cursor: pointer; }
        #status { font-size: 13px; margin-bottom: 8px; text-align: center; color: #eccc68; }
    </style>
</head>
<body>

    <div class="upload-container">
        <h2>ğŸš€ ClashData Pro</h2>
        <div class="tabs">
            <button class="tab-btn active" id="btn-file" onclick="setMode('file')">Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ</button>
            <button class="tab-btn" id="btn-url" onclick="setMode('url')">Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±</button>
        </div>

        <div id="inputArea">
            <input type="file" id="videoFile" accept="video/*">
        </div>
        
        <div id="status"></div>
        <div class="progress-wrapper" id="progWrapper"><div id="progressBar"></div></div>

        <button id="actionBtn" onclick="startUpload()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
    </div>

    <div id="videoList" class="video-grid"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAm1OfTW_qS4lhSGlqgDd6fiLDj3u93wqI",
        authDomain: "clashdata-8424c.firebaseapp.com",
        databaseURL: "https://clashdata-8424c-default-rtdb.firebaseio.com",
        projectId: "clashdata-8424c",
        storageBucket: "clashdata-8424c.firebasestorage.app",
        appId: "1:1063000922754:web:87087f81c28c2659cb329b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const CLOUD_NAME = "dkpddgzqj";
    const UPLOAD_PRESET = "b2aumssr";

    let mode = 'file';

    window.setMode = function(m) {
        mode = m;
        document.getElementById('btn-file').classList.toggle('active', m === 'file');
        document.getElementById('btn-url').classList.toggle('active', m === 'url');
        document.getElementById('inputArea').innerHTML = m === 'file' 
            ? '<input type="file" id="videoFile" accept="video/*">' 
            : '<input type="text" id="videoUrlInput" placeholder="Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±...">';
    };

    window.startUpload = function() {
        const fileInput = document.getElementById('videoFile');
        const urlInput = document.getElementById('videoUrlInput');
        const source = mode === 'file' ? fileInput.files[0] : urlInput.value;

        if(!source) return alert("ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ø£Ùˆ Ø¶Ø¹ Ø±Ø§Ø¨Ø·Ø§Ù‹");

        const btn = document.getElementById('actionBtn');
        const status = document.getElementById('status');
        const progWrapper = document.getElementById('progWrapper');
        const progressBar = document.getElementById('progressBar');

        btn.disabled = true;
        progWrapper.style.display = "block";
        status.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø³ÙŠÙ… (Chunked)...";

        const formData = new FormData();
        formData.append('file', source);
        formData.append('upload_preset', UPLOAD_PRESET);
        formData.append('resource_type', 'video');

        const xhr = new XMLHttpRequest();
        xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`);

        // ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ù„ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ù€ 100 Ù…ÙŠØ¬Ø§
        xhr.setRequestHeader('X-Unique-Upload-Id', 'clash_v3_' + Date.now());

        xhr.upload.onprogress = (e) => {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = percent + "%";
            status.innerText = `ØªÙ… Ø±ÙØ¹: ${percent}%`;
        };

        xhr.onload = function() {
            if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                push(ref(db, 'my_videos'), {
                    name: mode === 'file' ? source.name : "ÙÙŠØ¯ÙŠÙˆ Ø®Ø§Ø±Ø¬ÙŠ",
                    url: data.secure_url,
                    format: data.format,
                    date: new Date().toLocaleString('ar-SA')
                });
                status.innerText = "âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ù†Ø¬Ø§Ø­!";
                setTimeout(() => { 
                    progWrapper.style.display = "none";
                    btn.disabled = false;
                }, 2000);
            } else {
                const err = JSON.parse(xhr.responseText);
                alert("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: " + err.error.message);
                btn.disabled = false;
            }
        };

        xhr.send(formData);
    };

    onValue(ref(db, 'my_videos'), (snapshot) => {
        const listDiv = document.getElementById('videoList');
        listDiv.innerHTML = "";
        const data = snapshot.val();
        if(data) {
            Object.keys(data).reverse().forEach(key => {
                const v = data[key];
                // Ø§Ù„Ø³Ø­Ø± Ù‡Ù†Ø§: ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù‡Ù…Ø§ ÙƒØ§Ù†Øª ØµÙŠØºØªÙ‡
                const displayUrl = v.url.replace(new RegExp(`\\.${v.format}$`), '.mp4')
                                      .replace('/upload/', '/upload/f_auto,q_auto/');
                
                const item = document.createElement('div');
                item.className = 'video-item';
                item.innerHTML = `
                    <video controls preload="metadata" src="${displayUrl}"></video>
                    <div class="video-info">
                        <div style="font-weight:bold; margin-bottom:10px;">${v.name}</div>
                        <div class="btns-group">
                            <a href="${v.url.replace('/upload/', '/upload/fl_attachment/')}" class="download-btn">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ ğŸ“¥</a>
                            <button class="delete-btn" onclick="deleteV('${key}')">Ø­Ø°Ù ğŸ—‘ï¸</button>
                        </div>
                    </div>`;
                listDiv.appendChild(item);
            });
        }
    });

    window.deleteV = function(id) {
        if(prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:") === "1234") remove(ref(db, `my_videos/${id}`));
    };
</script>
</body>
</html>
