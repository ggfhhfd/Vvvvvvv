<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحميل وتشغيل مباشر</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
        .container { max-width: 500px; margin: auto; background: #222; padding: 20px; border-radius: 15px; }
        input { width: 90%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; }
        button { width: 95%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #status { margin: 10px 0; font-size: 14px; color: #f1c40f; }
        video { width: 100%; margin-top: 20px; border-radius: 10px; display: none; }
        progress { width: 100%; height: 20px; display: none; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h3>تحميل وتشغيل في المتصفح</h3>
    <input type="text" id="linkInput" placeholder="الصق الرابط هنا...">
    <button onclick="fetchAndPlay()">معالجة وتشغيل</button>
    
    <div id="status"></div>
    <progress id="progressBar" value="0" max="100"></progress>

    <video id="vPlayer" controls playsinline></video>
</div>

<script>
async function fetchAndPlay() {
    const url = document.getElementById('linkInput').value;
    const status = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const video = document.getElementById('vPlayer');

    if (!url) return alert("ضع الرابط أولاً");

    status.innerText = "جاري الاتصال بالرابط...";
    progressBar.style.display = "block";

    try {
        // سحب البيانات من الرابط
        const response = await fetch(url);
        if (!response.ok) throw new Error("فشل الوصول للرابط. قد يكون منتهي الصلاحية.");

        const contentLength = response.headers.get('content-length');
        const total = parseInt(contentLength, 10);
        let loaded = 0;

        const reader = response.body.getReader();
        const chunks = [];

        // عملية التحميل إلى ذاكرة المتصفح
        while(true) {
            const {done, value} = await reader.read();
            if (done) break;
            chunks.push(value);
            loaded += value.length;
            if (total) {
                const percent = Math.round((loaded / total) * 100);
                progressBar.value = percent;
                status.innerText = `جاري التحميل في الذاكرة: ${percent}%`;
            }
        }

        status.innerText = "اكتمل التحميل! جاري التشغيل...";
        
        // تحويل البيانات المحملة إلى رابط محلي يقرأه المتصفح
        const blob = new Blob(chunks, { type: 'video/mp4' }); // جربنا mp4 كصيغة عامة
        const blobUrl = URL.createObjectURL(blob);

        video.src = blobUrl;
        video.style.display = "block";
        progressBar.style.display = "none";
        video.play();

    } catch (err) {
        status.innerText = "خطأ: " + err.message;
        console.error(err);
    }
}
</script>

</body>
</html>
